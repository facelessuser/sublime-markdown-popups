"""Test image resolver."""
import unittest
from mdpopups import _ImagesToResolveParser, _ImageResolver, resolve_urls
import base64


JPEG_IMAGE_BASE64_ENCODED = '/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wAARCAEAAQADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwDtqKKK0ICiiigQUUUUAFFFFAC0UUUALRTQf3mPan0gCiiigBRRSUtAwooprglGA6kGgQvUc9K881SFINSnjjUKnmkBR0HNd3Ytm2Vc5CHZ+XFcdq6/8Tef/ro1RM0gVUHz/jQq/N9TSqP3uad0x9azRYuMkfSqd9diBAq4MjDgenualu7lbaLd1cjCj1NY6I8zlmOSeSTQBLo/+tm/3RWuB+8NZOkD5pfwrYx85qyRrD5l/Corb5bydfUBhVhhwD7Cq/3dRU/30I/rQAdquN0H0qnVz0+lCBjRxSg4PNAGTQ/HSgDuKKgvbgWlq8xGdo6VOp3AEd61MhaKKKACiiigAparXVyYJbZApPmybDx04J/pVmgApaSloArAr/aZG35vJB3Z96tVix3QOvN97GfL6H/PWtqkhhRRRQIKKKKAIZ7y2txmaeNPqwrMufEliilYzJKTx8gx+prnPEcH2W/l2DapfPHoRmsWUnzlZcnHOam7Ksju/DD/ALu6jw4UyCVN77jhh3Pc5BrC1cE6nP8A9dDWn4bmxPGM8OrJ+RDD+bVQ1UY1Of8A32qZbIqO5U/i/Go5pUhiLucAfrT3ZYwXc4A6k1jXEr3k3Gdi/dH9agsY7SXc+9vwHoKuxRBEwPSiCARgYHPepppEt4S8h68AdzQBR0knMn1FbJHzmsTR2+eUfStx+pqyRG6L9BVS5OyWGT0cA/jVtv4foKp3zKYJBkBl5xn3oAeau+n0rPSRZFDKcgitD0+goQMQdaRuTSj71V7m5jibBkAYdqAOr8SzeRok7dzhRzjuK0beQSwRyDoyg1geNZdmlRpn78g/QGtPQZfO0W0fqfLA/LitDPoaFFFFABS0lIx5XnGTQBj69deRe6WuAd1xnp7Y/rW1XGeM59uqWgGP3S7j07n/AOtXYxsHjVgcggGhAx9FFMmlWGF5H+6oyaAOUjgl/tzaLhvK8/G3fzjJrr65BI4BdCfB/wBZvxuPrnFdZG4kjV16MMikgY+iiimAUUUUAcx4stRJKh6CRMZ9wf8A69c6LKOMEsxbA712XiWPdYpJ/cf9D/kVx8hBlIbeeegz0x7VD3KRqaPL5UikdI5Ef8Cdh/R/0pNWI/tG4J6b2qvp2XcRdDKjJ9CRx+uKz9Z1D7ZcsITw/wAzEe/aplsUtyreXLXcvlx/6oHj/aPrU9tbhB05NJa2+wZI5q1LLHbRb3/AdzUlCSultEZH/AeprImlaV/Ml5Y/dUdAKdNM8sm+Tlv4U7LUkNvgF5OWIoATSOHkP0rcf7zfSsTSB98+4raf+L6VZIp7fQVVntIZWd2QFyhGTVk9voKOh/CgDJtJU8uOMdeRgCtcMAMscACsOKRYZmD8KjHmkuLqS745SL09frQBZvNRMhMdseO7/wCFVYoyeh69Se9Ojj46dO1WoFAYfXrQBu+OpPns4h/tN/KtPwfL5mhov9x2X+v9awPF8ouNXjWMhgsYxg+prR8DzqLWeFjg7wVB75H/ANarRHQ6qiiimIKr3cvlyWwz96UD9DVmsvWZlhls2Y4USbifpigDkvF0hk12UZ/1aKO/pn+tdtpMnnaXayE5LRL1+leea3J52sXjqRjeR25xxXa+FLhJNGgi3DegOR7ZNJDZtVQ11pF0mdozhgAemc89KuyNtjZsE4GcCs7W5QdMdFIZnwMA8nnnFDEciLy82ZAwoGc7OO3+NdpoxlbS4GmYFyueBjHtXJiKYrs8lyO4yPb/AArqtKlI02EMMMp2kZGRz3pJjNCikU7lByDkZyKWqEFFFNlcRRPIQSFBOB1NAFbVovO0y4Xvt3D8Of6VwkgPmZBbkYwDiugn8VI+5YoBtxg7zz+QrBk+YBkz/s4Has20y7NbiRMRwCyMp6g8j3Bqoll9mupo2YOY3KhvUdj+RqxDk5Yjr3qOSZIbiR5P4lBAHc9P6CkykSPIlvHvf8AOprMmkeWbe/Mh6L2UUsssksuTzIeg7IKtW9rsXJ5Y9TUjIre32fM3LGrWwlGPtSuUhjMknQVnveSSlhu8tMcACgB2kZ/eemRW2/Q1iaR0k+orbc8H8askQ9R9BUUk8cZ+dwOOhqC9vhB8kYDykdOy/Ws2NHkcsxLM3UmgC41vHIxYr96oDFscgfnV5RgComXLk0hkKsisIyRuPQVZiHzCqUMYbUZif4ACKvx/eH1oAzJpXmfdIS5HGT6VpeG5mi1i2XcVVpBn34I/rWYuGznvUlvMbeaOZfvRsGH4VSJPV6Kjt5luLeOaM5SRQw+hqSrICub8YPiADOMIT/n8q6UAmuN8Y3gE5iHUAIf5/wBaljRyzSNJI8h5Lkk556nNdN4IlP26SNmI2xEAE9fmBrlx93pzW34UuzbaxEg6TfuzQtymdzqUqx2bhmwWGF5wSa5S81RhcsGikYg8YHGK2vFDWxtI45pAkhbKHOOO9c5FJajKtOvH8TN1pMkf/ax5/wBHl4qzYan58wwrRhWBO7iqwltP+fmP86hZ7SVjmYLjuM80gO8tH32kTZBJQZI9alrI8MnOmZ87zPmI9gK2KsQUUUUAcj4h0qP7Y7QAIZF3HjuTzWRKotx5crqpx1ziuo1dv9MI9FFcn4jjxNFIO6lT+H/66z6mnQgN1bRH5SWPtk1TuJjcXCNGrAn5ee1NA3Qk+g6U2E4DH+7hvyP+GabQk9S7bwtGMbBk981O8xiUgsm8DhTSXUrQRZjXLHv6VmxbzLkHczdSeagsXe7TEygux7elTTWyo7bemM4qzMq/aE/vEAUy8z5nAJ4/AUAV9I6P9RV69vFUPFE2ZPXGcVmWIcwSLG2HJ9KlghywFUIYkR3Hdnd3Jq3AoDUFcyH61LGMUAPptOqOSRY9u7PzHFAEEDBdRnB6sox+lWiSCuDgkgCqG7Gos4+6R97t0q3HIglUs+TnjjpQBQVPl4NLjnPYCkQkoNvU9ab0fB6YFUSep6Pg6TZ8f8sU4/AVbkaJGRS+Gc4UepxmqOhvnRbM5z+5Xn8KyfEmtNp97apDhmjPmOD6EY/xpsR1EYx3rzrxiwbVpiucFh39q6mw8S2lxtWX9zIf73T864zxNLG+oylG3c9RSGZnJwc+laOhNs1uzON375Rj6ms8/dAHQVNpz41GBs7SJVwfTmgDufGSkW1uVUE7mxn6VyFxAzzRlV4/i4rpPHc8iNZpG+FIY4/KuZWdgwJOeOhqeo0NFs+ZflOD9386ntY3jQLtBOec0w3jngY/EVV+0Slvvn8PpRqM7fwlGoS5faA5Kgn8K6KuR8E3jvcXFs5z8u8Hv1xXX4ANWtiHuJQRjrxVLV9Vh0i2E0qs+5tqqvc4z/SuG1bxLd6k3luRHBuz5a/1NFwSNnXtQSPUJVRg5GBgfSub1OR5k3yNkg8DGMUya6jiUFWV2x24A/Gs97h5TjJI/SoS1uaNq1kTQlirqM4x2GaiUsrkA8nK/nxSxsQ/Az7U1wVfke/XNWZFrT9xdQy59SanVURwq45bFJaMBOyDHUkfQ8/1p4jJkyxzhwR7Vkakk0bNcIQcAdfenTD5ZD/smpD97PtUV02yJsDqCKEBS0ofu3P+1/SrUS4cmqulf6p/97+gq8owaoQ3HzE05eKMUDrQAGobr/Vr9T/I1MelR3S4gU98/wBDQBK0ILRBQi92G0c1DCP9OOI/LHofoakuwVVdiMT/ALIH86q2zsJ8ykjH97twaXUroVochRSZBZs/3RV2SEP04PrVRoysjA8cf0qk7kuLR0Gla9c2emxQqqlUB5P1zWTfXkl9dPcS/ec9Pao1bFqqDqc5/Ok8s8cCmySe3YPHg9RxVa927mA64pyExSZPQ8Go5hukc5oATop+lMQ8n1zTm7fSkjXO4+9AGrq+ozalJb/aCMKMDaMcVRQ7sDrRIciHJ6LmlQfMuPSkMkdMrlR06nHSqxwZcHsM/pVkljuPfoearhcsT7UIGb3g5imtqR0kjYH+f9K73NedeGnZNftwn8TEHntg16JVLYlnK+PiRY2vOB5p/PFcM7bAMHc57DtXb+PHzDaRepd/yH/164zTYhNcspweM9allLYILN5fmfJNX4rIKORV9IQgwBTmKouWYKPUmkM55wYpyucbWxROMFSO4p980b3TtEwZT3FNk+aMHr7egqzMs2RBuEPcp/Lj/Cro6n61m2LYmj/3iv5j/wCtWmi5LZ6ZzWb3NFsLKCSuOxBNNulBgkJ7KSKlP9Kiuzi2k/3TSQyjpWPLb6/4VfFUNK/1bf739BVyGTzYw4GM9qoQ80gyegqQR9z+VNlmjhGCeeyjrRYAEZI54qO+4gUeh/oaYZp5fuARj1PJpl0xMapuJ2jk+pwaOgLclt12IiuMlzkOvP51A6f6UyMQR7D2NWbV43R/Ljwq9/U1Ujl82YHYqY/uj2NIosUjqrDDY9qh+1DurflTvtUTLtYfmKmzLuiPyCg/vDoDmlwwYnb1zSbnXLQkuv8AdIq1Z30ZGySEEdOnSrM2uxUdSQVIHTjmmRxtKG2glsHOK31hsnTckaEDqMUyKztlk329wpdlO6MYwBjpTIMFhwDntSonHXk1YnVY5GTaPlPpUBx5hHpmgYSEgRg9gaeh5HHbFQli7Bf7tSjcCGAz9aAHZIJBNRBsNzU/mPgHy1/KoCGL5PFAGr4cP/FQWvP8Z/ka9Gry+wne11KGdACUfofyr0XTLp7yzWZwoYkj5TkdapbEs5fxokp1CJnI8kW77O/Pf+lctp0628rSEFyRhQoxXY+L2Wa7toEkHmCN9wznaDjkiuVFr5DkNyfWoZS2HyXt1LwgWIe3Jqu0TSNmV2c+5zVlQW4Rd3uelPEMh6sFHoKQzPniI29h06UwKzYXLH2q7dW6pbu5JJFW7QKLWPAxxVXsJq5mCOSFDJ5bAKQ2SPQ1rRn71NnXfGy/3lxVaxnLqilSMqck9yKm9x2sXGz2qG9P+jSf7tSk461Xv5AsDgnquKQyhbADTrhs7ecZzjntTtIuEiSUMxZsjAHOapBpdmAp2E5x2oj80Sb4Rg1ZJtmSebp+7X260R26oc4yfU0Wcjy2yyOu0t2qcUAIBxVO54XHuf5GrtUrs4YexP8AKkxrcsWkQjjVXIywzg9aqJGYblkPY8fTBqe5Tz0heEdepHao5JFe6OzG0YAx9DSKOne1tcjf5YJGecVm6nbRo8ZiRNuDyuOtO1ZR9rjzniA/yqApjT0IY59M9KGxJFfaRSeUu7djBpAsmepP40oEo/vflUl3Q75lORmrkF9GI0jlgQ7f4sc1T3P3/lSbznkDH0p6g7MZdorTOykgMcge1VUBO4DPXP4c1cJBGCoI/GoWh2kleAeeTVJkNdisy7pOvX/Gnxg525GB3NNcfN0x9KEABBDHPWmSTbJFAJ2ge9RYYyEEe3FSszDnOR6VEpO/pQAuGVwRyQc/qK6Ww142ejpbw5kl5xIw6ZJ/+tXPI6gkkNn/AHTUgnXONr5xnGKTb6FJLqPJl+1PcySF5GOSxpwgeT55ScHoPWmxPvkUGNgM9SKufxJ6cH9DSQO3QhOIoi54VfQUsRWWMOMkHpmmSj/iWSfRv5mn2I/0RPpTEULmYulxFtACDr+Iq7bH/RY/oKz5R+8vPp/UU37TMYREoCqAPrSYGlI4UjcQBjvWbHcC3kkGQy7jtwM8E5phillOXYn605bekMSa9llOFAQA8etQMrspZiTgdTVpYAD0p0yAQv8A7poAgs1EsLKezU+3QJavJ6Bv50zT/lJ/2v6f/rqaLDWuzP3pMf8Aj1WSXo42S3jRW27VAPHtTwCqgEk+5p46GmseRQAlUrzmQD2P8jV0VRvP9b+H9DSY1uXDCB5SLtXuwx97FU3GLlsR+WM9PwNWLSMIqeYQXbnDcmqxjaO5ZTkjPGfTmkUbuq/8fa/9cP6VGIPtFlHFgfN3NbM2n2077nTJAx+FVJbaK2njWLgHnb6UWJuY50cE4VlJ9mpP7Ik52t09Gq1bKf7Xl5OMdM0WYYreAsTjOMnpQBUOmXQ+68mPZ6Q2F6Bw8h/HNWELnRN+9t+4c96nvC62UBViDuGT+FAGYkF6xcZY7TjlAeajeSaJtkhG7/dFais634RWIUyHI9eBUktjDNKzumWJ5O4igLmIpBFFbB0u3KkKpU+u4mq8umeXj58e5FMDOUnccdulPbDDcBg9xVz+y3MZkQghepJxntTFsZiwAKk+zUAQgFrKT+8pGCOppk8wF3bSKeDGCfz5rWh0tXiljMhDsAQRj5TzWEbSddSFpt3SKMYH501a4N6HQtbgQ+YDkYz0qDHKfQfyNW44Xi0/ZMf3iKM4biqp6x/QfyNSMrS/8g2X6N/M0+x/49I6bLxp0h9A386S3mWGwR3IA6dcd6YihN9+8J6f/XFSQRgRJgfwiopmy150xjj8xViDiBM+gpPYEKVFAWncE9RSGaFOGcZ9ByaQxyxjFQ3S7YZP900Nep/CjH8MUXE6Pav2JU0WAh0yGOWEiRA2G4zU9nbwhWfy13K7AHHTmo9IP7px/tVDHHcR3LxqzhCzHG7FWSapOFNNLAgEHNZswzFITLKy9MM3T61FAhIUeYwOSAoJwf8ACgDXU5qjeH98f89qrB3kTO9wp6DNJEcwR5OTg/1pMaNILtSDyUV933mI/rUDKFuiBgcjgHIHWp5V8u3Ty42yRzsUfrVKMsJPmBHPQj60upXQ7/NUb0/6VF8vbr61nX91c27xJ9of5kzwKjtbmWT947NLj7oJptkpE0EbrqLyEDa3ANJbRsi3OQPnyRTxdSg8Wrfmf8KUXM3a1P5n/CkBAsDjTPJwN+elS3MbyWkKqOQQT+VP8+47W3/j1KJLojH2cfnQBXRGa/LgZCyHPtlVqK8mu47hxDJtTPA4qxbNc+ZPtiX/AFnOT0OBVa+gkuFAIUMGJPpTAiNxqCjJl/MCmvLfEAmUj6HFWb2H7RAqIMEHJyPr/jS3UPnWqxKMMMZJFAFZZL9UGHLAc880iXN9nrnA7gVowskUARlJIXHT6f4VVs4RBJMz/MJDkYHTr/jQBZ0maeQy+exJAGP1rKWUjxSWH98j9K1LOJ7aS5lKFt53BR171nXbS3F3FcramN0PJB60LcGbl4cQ7h3wP1qgesf0/pVUXR4SZTGOmTirBcDyyxA4xz64pAQTf8g6X6N/M1lXNwXs1txGwAPLY6mtWb/kHS/Rv5mqRUfZlyOu0/rimBVjkLx3DOpB2gkH6ipVYlRhWHHrUbNlLr6Y/UVftVBiU+woYIqHcBkA/nTFcE48tc1pmMEdKoMnkze1TcYwgkf6sD8KjcHy3+UdPStERDFQzoBBL/umhMBukZ8t/rVx1/0kHHrVTSTmE/71Xn/1g/GrJIJLZSGaP5GI5I7/AFqmttIilkC7hkg7ifbpWn2NQj7ooAoIuyMKeME/j71DGSLdCuOCev41al4mxjPFVo8fZ159f50iga4f2P1p0UhfqQuD2FRMRjpRGuEZvegVzqNXUm4gx/zzNQ2OUVfXGf1qfUmLzQlY3b932X1qG13ZVXRkIXHIqWNE/wDaMQu/K525xvzxmo49VRpGDqyx4JDbuuKqQoF1Ux7BjJNJZqCt2uwfKuBVXFYsf2oDAx8siTcAFJ4PvTm1HbZrIIwJGJAU9OKp4zpRbaud/Spr0Eafb4Azx29qAGpfyCVxFGoLNuIYdeBwKsX1yYEVgmSzHgnpVfkXy4/56jP5CpZ/LnmeMmRipyQOgoAlvJzBCrquSWxjPtRczmK2EgUEnbx9RSTqs8YVkfGc8YqK7gE8PHmqQBjnjgUATwzmZQIot7EDJP3VNXLe3EfzMd7+p6D6VQ0h2SIwkcJ0NaWT60hgD++b6Cql1cLbW7yspO0dqW4uo7cs0rEZGBjvWRfyR3YVIZnHcgng0IGWpBHeG2ulUFSCo3Dof8g1A8GdRJcMRtBUZ4Ax1/P+dN0tWjbYzs0ZBwuOAc//AK6ub1nk3LkNGShz36UySrezrBa+UfmZ88Vlm4lIA3AKOgxxU+q5+2c/3RiqX0qkla7H5ImWQNHKu353Hboec1o2cqNGArZwKyl4Zcdc8VoWkRErEj5SpAI+tTJW0BO+pfJHqOagmhWTnODUxUgqAelNZST0H1NSMrvcNGQu0HimykvZysRglTUc5/jXr05p7/8AHixJIJQ/yoAbpX+pP+9Wgw5rO0r/AFJ+prSY1ZIz1qLFSjoajNAFS5HzA5xnoapAERDnjJ/nWpIgcDIzVO8TaVVeBikMq/NjqPypY84Ixmk5706P7xoA7pp7dfvTRj8az7qeD7QrrKCMYqS5lhtbcyhFP90AdaoT3AuYI327SCQRQwQqbG1NZEdWBXHFR2fW79xT1yro6JuI7ZxTY454zIQiASerdKQ2R4/4lJGf46mu+bKAfSmCCX7P5RePbnOcc05oZJI1R5TtXphaYho/4/Qf+mv9BUOooRKWBPLEdamghEjyF2clX4IOOwprCJdwmDMA+ASelAC32TbQ/h/KllY+VbpjP3STn2qWcQqg87O0HApsqxkruDAKAUINAEtlxK1W55lhheVuijNU7Q/vT7ip7pUlt3jc4Vhgn0pMaMKXV5JXbfFGVYYwRnFTQwxPbGSMHei5OB3xVI2EgfGQV/vAdq2LHBs2AUhRkDPcYqnboIqWdxEjByxPJ4A9z/jVm2YSSzspIBbNZttarLOo6ZzV7ToTDLOpxgEDikAX9mbhQVI3DoayWgmRtrRnNdE1VLn/AI+Lf/eNCbWwPVWZlG3eGBpmwCOgrSsxtiB64FN1UgWTZIGSMU+05hByCPakx3J8g89Mil6Ln3pCMnntTWzgntQIpSDMZ+tTFN1mygZJTio2H7s/WrMRAjAPcAUdQ6FWwiaJCr9Qe1XmqLGGbHrUrdapCZGD1pnPelLgH3poOTQAvaqd9/rB/u1bIBkRWbaCcZ/Cql8pSTaW3YHWkMp0sf3/AMKSnRff/CgDfvPmtLZWPQn9KgkXZGvoTVm9KiCInqM4qCc/u0+tDEh0bYUYIzjjPrUVvdbYHBwzIvDDv9aTaXVSGKgHnFRWmfs90Om0ECkNk7Xsn2beE5LY6cUl3dTRwRMo2lhziq7ljpKNk5Ldadfbj9nUdMjmmA5JZWuQFkChmzx349KmkRbhnjHyFX5JHWq6qP7RTHZm/kKfLDMblnUkoT0zigRentxOm3cF+YHPrSSqAjLkZVRyR3quqyAYLf8Aj1RyW8rvu87AHIHJoAj86WOBSkn7z1x2pGllkXEkhb61C6zBiDtPvinNkR5A+b0pFJpFtVYhSFY5XjjrUcMtxHanZtKYJ5606O8KpFlcbFIOaahzp/ynqlUSOsIxmOUso6/L39Kng4uJj6tisZZjazRyglhtJIJ75Iq/Y3H2iPzCACZBkD6Uhl2SRUVmYgBT1NVpHWWW3dGBGT0NPuYhcRSxF9pJ9KqQwC1aCLduO4kmiwh+qkNZnocMKlsv+PdcDHAqjcytJBchjkI4A/Or1p/qFx6Ck9hljPzU1v8AVNUN5ci2XcepOBVaLUkkglLcFeR70AAJLuO2B/WrUB8yIHpj/HFZNvfBnbzcDPcVrWoAiGDkHnP40dQ6Cn75qRqj/iNPY00DKtyuVDD7w71FbZ8w5z071ZkGRzTI1ANMQ24Gdg/2v6Gq1wMY+n9ausAXTPqf5Gql5jcMdhSGVDSw/f8AwptOi+/+FAGnJfrMiA4G3vzzU5BngLoY2ROSQTxWMXj2AZOc9R1rW0m/hhXyHQfODncvDU1qD0GfaPLBXbz70lsR5VwOjPnA9fpVW52uJAGUANx15pi3Pkxgoy7s+lFguXjDJ/ZiJsYMCCQRS3BWVYirqdhyeaWyzNaycSq7vhgG4UdQRWfd5t5toZlDgEluveiwrl+NC1z5oBwrH9QKsep29+uKradMhgCsxJZsEjGenWtJTbrnbNcdO7D+hoQMqs5CkgZIFRQSs8WXAB+tRyXAWVwrAJn+Ltmq8Fy8pIQuSOuBxT3E9C+IHcbgvHrkVBNCYmLSAgAgY+pxVSe6kRSjR4bsxXFVp5peOWIByc8/nSsO5dniWBH2OzA84btxTrFxcxDzTiNBt2j+I1VkuVnDYz078U7T5z5bJjgA0ICG9mjYhIc7BkDPpnP9adpMzLdpEPuscn8KbDZNOSd6oABVi0sTFeo5kUhcnijQC9uzNK/YHbUJJN5Ee2ahlO52bAYkkjmm2h3TIcY5oAa3Nvdn/pr/AFrQgG62ABwSBWcebK6P/TX+taNtxCv0pMaM3WGYSIhOcL196z87Ripb2RpLmQt13YqBuuKEIBmui08n7KmTzgVzmK6HTP8Aj1T6UMESMT54HYg5qU1Cf9ePoalboaFsDGHmgLUc8vkx78Z5xUgPFMBk4YKrJyVOap3BLKCRg81eR9xYf3Tiqt994fSkMo06L/WfhTDSxH94KALj6V5khc3B5OSMU9tOYoqrPjbyDt5/nVjPHWkzno1USVo9MKtlpy/sRxSNpKsxJmYZ9BVrPA+ajcfWgCsNMKjC3Mij0FC6XiUO8xkx2YZq1vPrSiQg9c0AQTWLOgWOQR4OflXFH9nsOlxL/wB9f/Wqz5nvSmQCgDIu4pLUjL79xO3HWqqs2Nyo+PUCt6VY5iDIoJXpntURt4R91SPoxFAGG8pY/MWOPWpImD/JycjmtV7OKQcs/wCL/wCNJDaQQB0G/wCcYz1oAz4YwRJ1IC1PYRYkVsEBuPrwa0obSNEKqFBYgkn+VSvDtjKoFXPdR0oAyoAxuGj28Bev0q/bhYw5kO0leM+lCRmFCMg8HJI5NV5y9wJUyFdcL+Hr+VIZQtGzeSKDlWzg1atRsljy3GTx6VUSEpcCSLmMHGQelWU+aQBTk7jQBPeIkdlL5fGWBP5ip7ckxL64qjeBhCQVNSWkyxworZHHpSGZt3G8dwyuOc1CevStXVNsqB1wdvcVmEAnpTQhuT61rQSzpbRtH+IxWWqBnVckZOK3LUAQqvoKTBEuCZgf9n/CpWPBqPPJoZjuA7UICtqAzAPZhVkdBVe+/wBSP94VYFMBI/4v941VveZMe1WkUruyc5JIqrdf68fSkBUMZ78UiDbIKlcjPWoh/rR3oGf/2Q=='


def mock_resolver(url, done):
    # for testing purposes, pretend this is the image we resolve
    done(base64.b64decode(JPEG_IMAGE_BASE64_ENCODED))


class TestImageResolver(unittest.TestCase):
    """Test image resolver."""

    def test_one_image_tag(self):
        parser = _ImagesToResolveParser()
        parser.feed('<p><img src="http://example.org/image.jpeg"/></p>')
        self.assertEqual(len(parser.images_to_resolve), 1)
        for k, v in parser.images_to_resolve.items():
            self.assertEqual(k, "http://example.org/image.jpeg")
            # rows are 1-based
            # cols are 0-based for some reason
            # the position is the opening `<` of the `<img>` tag
            self.assertEqual(v, [(1, 3)])

    def test_two_image_tags(self):
        parser = _ImagesToResolveParser()
        parser.feed('<p><img src="http://example.org/image.jpeg"/><strong>hello there</strong><img src="http://example.org/image.png"/></p>')
        self.assertEqual(len(parser.images_to_resolve), 2)
        self.assertEqual(parser.images_to_resolve["http://example.org/image.jpeg"], [(1, 3)])
        self.assertEqual(parser.images_to_resolve["http://example.org/image.png"], [(1, 73)])

    def test_three_images_one_which_is_a_repeat(self):
        parser = _ImagesToResolveParser()
        parser.feed('<p><img src="http://example.org/image.jpeg"/><strong>hello there</strong><img src="http://example.org/image.png"/><img src="http://example.org/image.jpeg"/></p>')
        self.assertEqual(len(parser.images_to_resolve), 2)
        # http://example.org/image.jpeg has two locations
        self.assertEqual(parser.images_to_resolve["http://example.org/image.jpeg"], [(1, 3), (1, 114)])
        # http://example.org/image.png has one location
        self.assertEqual(parser.images_to_resolve["http://example.org/image.png"], [(1, 73)])

    def test_image_resolver_class(self):
        minihtml = '<p><img src="http://example.org/image.jpeg"/></p>'

        def done_callback(transformed_minihtml):
            self.assertEqual(transformed_minihtml, '<p><img src="data:image/jpeg, {}"/></p>'.format(JPEG_IMAGE_BASE64_ENCODED))

        resolver = _ImageResolver(minihtml, mock_resolver, done_callback, {"http://example.org/image.jpeg": [(1, 3)]})

    def test_resolve_urls(self):
        minihtml = '<p><img src="http://example.org/image.jpeg"/></p>'

        def done_callback(transformed_minihtml):
            self.assertEqual(transformed_minihtml, '<p><img src="data:image/jpeg, {}"/></p>'.format(JPEG_IMAGE_BASE64_ENCODED))

        resolve_urls(minihtml, mock_resolver, done_callback)
